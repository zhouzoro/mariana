"use strict";function loadContent(t){$("#body-loader").show(),ScrollTop(),history.pushState(null,null,t);var e=$("#main_body");$.get(t,function(o){var a=$("<div>").attr("class","main_body");$("#body-loader").attr("class","in-progress"),e.html(a.html(o)),$(".carousel")[0]&&$(".carousel").carousel(),$(".a_nav").each(setNav),setPageNav(),Cookies.get("username")?setDelete():downloads.screenDownload(),"/upload"==t&&myUpload.init("news"),$("#body-loader").attr("class","complete"),$("#body-loader").slideUp()})}function setLogin(){$("#upload_entry").css("display","none"),$("#log_out").css("display","none"),$("#login_entry").css("display","inline-block").click(function(){$("#ldlog").modal("show")}),downloads.screenDownload(),$("#login_submit").click(loginSubmit)}function showLogin(){$("#ldlog").modal("show")}function setUser(t){$("#login_entry").css("display","none"),$("#upload_entry").css("display","inline-block").click(function(){loadContent("/upload")}),$("#log_out").css("display","inline-block").click(function(){logOut()})}function logOut(){Cookies.remove("username"),setLogin()}function setNav(){$(this).off("click"),$(this).click(function(){$(".collapse").hasClass("in")&&$(".collapse").collapse("hide")});var t=window.location.pathname,e=t.substring(t.lastIndexOf("/")+1);if("records"==e){var o=window.location.search.substr(7,8);e=o.substring(0,o.lastIndexOf("&"))}$(this).data("type")===e?$(this).click(function(){ScrollTop()}):"home"==$(this).data("type")||"staff"==$(this).data("type")||"about"==$(this).data("type")?$(this).click(function(){loadContent("/"+$(this).data("type"))}):$(this).click(function(){loadContent("/records?t="+$(this).data("type")+"&p=0")})}function setDelete(){$("#modify")&&$("#modify").data("owner")===Cookies.get("username")&&($("#modify").css("display","inline-block"),$("#delete").click(function(){var t={username:Cookies.get("username"),_id:$("#article_detail").data("id")};$.post("/delete",t,function(t){t.result?window.location="/":alert("Something went wrong!")})}))}function loginSubmit(){var t={username:$("#login_username").val(),password:$("#login_password").val()};console.log(t),$.post("/authentication",t,function(e){e.result===!0?(closeDlg(),Cookies.set("username",t.username,{expires:7}),setUser(t.username),downloads.allowDownload()):alert("Authentication Filed!")})}function showDetail(t){var e="/details?_id="+t;loadContent(e)}function closeDlg(){$("#ldlog").modal("hide")}function setPageNav(){var t=$(".load_previous"),e=$(".load_next");$(".pagenum")&&$(".pagenum").data("pagenum")>=$(".tpagenum").data("pagenum")?e.off("click").addClass("disabled"):e.click(function(){newUrl="/records?t="+$(this).data("type")+"&p="+$(this).data("num"),loadContent(newUrl)}).removeClass("disabled"),$(".pagenum")&&1==$(".pagenum").data("pagenum")?t.off("click").addClass("disabled"):t.click(function(){newUrl="/records?t="+$(this).data("type")+"&p="+$(this).data("num"),loadContent(newUrl)}).removeClass("disabled")}function ScrollTop(){var t=$("html, body");t.stop().animate({scrollTop:0},"500")}function controlNavPosition(t){checkVisible($("#logo-img"))?($("#scroll-top").hide(),$("#nav-content").css({position:"relative","padding-top":"0px","background-color":"transparent"})):($("#nav-content").css({position:"fixed","padding-top":"10px","background-color":"#222"}),$("#scroll-top").show())}function checkVisible(t,e){e=e||"visible";var o=$(window).height(),a=$(window).scrollTop(),n=$(t).offset().top,i=$(t).height();return"visible"===e?o+a>n&&n>a-i:"above"===e?o+a>n:void 0}function GetCurrentDate(){var t=new Date,e=t.getMonth()<9?"0"+(t.getMonth()+1):t.getMonth()+1,o=t.getFullYear()+"-"+e+"-"+t.getDate();return o}$(document).ready(function(){loadContent($("#main_body").data("init-url")),Cookies.get("username")?setUser(Cookies.get("username")):setLogin(),$(document).scroll(controlNavPosition),$("#scroll-top").click(ScrollTop)});var downloads=function(){var t=[];return{screenDownload:function(){$(".downloadlink").each(function(){t.push({linkid:this.id,href:$(this).attr("href"),download:$(this).attr("download")}),$(this).removeAttr("href"),$(this).removeAttr("download"),$(this).click(showLogin)})},allowDownload:function(){$(".downloadlink").unbind("click",showLogin);for(var e=0;e<t.length;e++)$("#"+t[e].linkid).attr({href:"../../"+t[e].href,download:t[e].download})}}}();$(document).ready(function(){$(".log").each(function(){"error"==$(this).data("level")?(console.log(1),$(this).find("label").addClass("log-level-error")):"info"===$(this).data("level")&&$(this).find("label").addClass("log-level-info")});var t=io.connect("http://127.0.0.1:30000/");t.on("log",function(t){if("object"==typeof t){var e=$("<div>").attr("class","log"),o=$("<label>").attr("class","log-text log-level").text(t.level),a=$("<label>").attr("class","log-text log-timr").text("_at_"+t.date),n=$("<label>").attr("class","log-text").text(t.message),i=$("<p>").attr("class","log-text").text(JSON.stringify(t));"error"===t.level?(o.addClass("log-level-error"),a.addClass("log-level-error"),n.addClass("log-level-error")):"info"===t.level&&(o.addClass("log-level-info"),a.addClass("log-level-info"),n.addClass("log-level-info")),e.append(o).append(a).append(n).append(i)}else if("string"==typeof t)var e=$("<div>").attr("class","log").text(t);e.insertBefore("div:first")}),$.get("/logs",function(t){console.log(t)})});var myUpload=function(){function t(t){$("#loader").modal("show");var e=$("#loader").find(".loader"),o=function(o){e.text("uploading "+o+"of "+t.length)};_.forEach(t,function(t,e){e++,o(e),data={date:GetCurrentDate(),type:$("#upload-type").val(),title:t.title,name:t.name,source:t.source,path:t.path},console.log(data),$.post("/add_new_post",data,function(t){$("#loader").modal("hide"),console.log(t)})}),loadContent("/home")}function e(t){var e=Math.ceil(1e3*t.loaded/t.total)/10+"%";return e}function o(){this.title="",this.name="",this.source="",this.path="",this.progress="0%",this.updateProgress=function(t){this.progress=e(t)};var t=new XMLHttpRequest;t.withCredentials=!1,t.open("POST","/files"),t.onload=function(){var e=JSON.parse(t.responseText);this.path=e.location},t.upload.addEventListener("progress",this.updateProgress,!1),this.uploadFile=function(e){this.name=e.files[0].name;var o=$(e).parent(".frmfile")[0],a=new FormData(o);t.send(a)},this.abort=function(){t.abort()}}function a(){var t={atts:{}},e=0;return t.states=[],t.addAtt=function(){t.states.push(0),e++;var a="att"+e,n=new o;t.atts[a]=n;var i=$("<form>").attr({"class":"frmfile",enctype:"multipart/form-data",method:"post",hidden:1}),l=$("<input>").attr({id:"iptfile"+e,type:"file",name:"file"+e,hidden:1}).change(function(){n.uploadFile(this)});return $("body").append(i.append(l)),l.click(),n},t.wrapUp=function(){var t="";return _.forEach(n.atts,function(e,o){o++,t+="<p>附件."+o+'： <a href="'+e.path+'" download="'+e.name+'">'+e.name+"</a></p>"}),t},t}var n,i={};return i.init=function(e){if(console.log(e),"refe"==e){$(".news-only").hide(),$(".data-only").hide(),$(".refe-only").show(),$("#btn-add").show(),n=new Vue({el:"#app-r",data:{refes:[]},methods:{remove:function(t){t.abort(),this.refes.$remove(t)}}});var o=a();$("#btn-add").off("click"),$("#btn-add").click(function(){n.refes.push(o.addAtt())}),$("#btn-upload").off("click"),$("#btn-upload").click(function(){t(n.refes)})}else if("data"==e){$(".news-only").hide(),$(".refe-only").hide(),$(".data-only").show(),$("#btn-add").show(),n=new Vue({el:"#app-d",data:{datas:[]},methods:{remove:function(t){t.abort(),this.datas.$remove(t)}}});var l=a();$("#btn-add").off("click"),$("#btn-add").click(function(){n.datas.push(l.addAtt())}),$("#btn-upload").off("click"),$("#btn-upload").click(function(){t(n.datas)})}else{$(".news-only").show(),$(".refe-only").show(),$(".data-only").hide(),$(".refe-only").hide(),$("#btn-add").hide(),$("#upload-type").change(function(){i.init($(this).val())});var s=a();tinymce.EditorManager.remove("#input-body"),$("#btn-add").hide(),tinymce.init({selector:"#input-body",plugins:"advlist link anchor paste image autoresize preview imagetools",toolbar:"undo redo formatselect advlist fontsizeselect bold italic underline strikethrough alignleft aligncenter alignright link image preview",image_caption:!0,paste_data_images:!0,fontsize_formats:"8pt 9pt 10pt 11pt 12pt 14pt 18pt 24pt 36pt",menubar:!1,images_upload_url:"/images",content_css:"/app.min.css",min_width:420,max_width:960}),n=new Vue({el:"#app",data:{atts:[]},methods:{remove:function(t){t.abort(),this.atts.$remove(t)}}}),$("#input-img").off("change"),$("#input-img").change(function(){if(this.files&&this.files[0]){var t=new FileReader;t.onload=function(t){tinymce.activeEditor.execCommand("insertHTML",!1,'<img src="'+t.target.result+'" width="80%" >'),tinymce.activeEditor.uploadImages()},t.readAsDataURL(this.files[0])}}),$("#input-date").val(GetCurrentDate()),$("#btn-att").off("click"),$("#btn-att").click(function(){n.atts.push(s.addAtt())}),$("#btn-upload").off("click"),$("#btn-img").click(function(){$("#input-img").click()}),$("#btn-upload").off("click"),$("#btn-upload").click(function(){$("#loader").modal("show");var t=$("#loader").find(".loader");t.text("uploading Images"),tinymce.activeEditor.uploadImages(function(e){t.text("wrapping together"),tinymce.activeEditor.save();var o=s.wrapUp(n.atts),a={type:$("#upload-type").val(),title:$("#input-title").val(),date:$("#input-date").val(),owner:Cookies.get("username"),source:$("#input-source").val(),cover:$($("#input-body").val()).find("img").attr("src"),body:$("#input-body").val()+o,att:o};t.text("pendding"),$.post("/add_new_post",a,function(t){$("#loader").modal("hide"),loadContent(t.url)})})})}},i}();